# 1.索引

## 1.1 索引的意义

对要查询的字段建立索引其实就是把该字段按照一定的方式排序；建立的索引只对该字段有用，如果查询的字段改变，那么这个索引也就无效了

## 1.2 优缺点

### 1.2.1 优点

1. 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性。 
2. 可以大大加快数据的检索速度，这也是创建索引的最主要的原因
3. 可以加速表和表之间的连接，特别是在实现数据的参考完整性方面特别有意义
4. 在使用分组和排序子句进行数据检索时，同样可以显著减少查询中分组和排序的时间
5. 通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能。

### 1.2.2 代价

1. 创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增加
2. 索引需要占物理空间，除了数据表占数据空间之外，每一个索引还要占一定的物理空间，如果要建立聚簇索引，那么需要的空间就会更大
3. 当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护，这样就降低了数据的维护速度。

## 1.3 不适用情况：

1. 需要取到所有表记录，无论如何都必须进行全表扫描了
2. 对**非**唯一的字段，例如“性别”这种大量重复值的字段
3. 对于记录比较少的表，因为索引是需要存储空间的
4. 当修改性能远远大于检索性能时，不应该创建索引。每次执行update/insert/delete字段的索引都必须重新计算更新。
5. 对于那些定义为text, image和bit数据类型的列不应该增加索引。这是因为，这些列的数据量要么相当大，要么取值很少。

## 1 .4 适用情况

1. 经常需要搜索的列上，可以加快搜索的速度
2. 在作为主键的列上，强制该列的唯一性和组织表中数据的排列结构
3. 在经常用在连接的列上，这些列主要是一些外键，可以加快连接的速度
4. 在经常需要根据范围进行搜索的列上创建索引，因为索引已经排序，其指定的范围是连续的
5. 在经常需要排序的列上创建索引，因为索引已经排序，这样查询可以利用索引的排序，加快排序查询时间； 
6. 在经常使用在WHERE子句中的列上面创建索引，加快条件的判断速度。 

## 1.5 创建索引的方法 

1. 直接创建索引，例如使用CREATE INDEX语句或者使用创建索引向导

   1. 可以定制创建出符合自己需要的索引。
   2. 使用许多选项，例如指定数据页的充满度、进行排序、整理统计信息等，这样可以优化索引。
   3. 可以指定索引的类型、唯一性和复合 性，也就是说，既可以创建聚簇索引，也可以创建非聚簇索引
   4. 既可以在一个列上创建索引，也可以在两个或者两个以上的列上创建索引。

   

2. 间接创建索引，例如在表中定义主键约束或者唯一性键约束时，同时也创建了索引。

   1. 当使用约束 创建索引时，索引的类型和特征基本上都已经确定了。
   2. 在创建主键约束时，系统自动创建 了一个唯一性的聚簇索引。在物理结构上，与主键约束相对应的结构是唯一性的聚簇索引。
   3. 同样，在创建唯一性键约束时，也同时创建了索引，这种索引则是唯一性的非聚簇索引。

## 1.6 索引的特征

### 1.6.1 唯 一性索引

唯 一性索引保证在索引列中的全部数据是唯一的，不会包含冗余数据。如果表中已经有一个主键约束或者唯一性键约束，那么当创建表或者修改表时，SQL Server自动创建一个唯一性索引。然而，如果必须保证唯一性，那么应该创建主键约束或者唯一性键约束，而不是创建一个唯一性索引。

### 1.6.2 复合索引 

复合索引就是一个索引创建在两个列 或者多个列上。

应该考虑这些规则：

1. 最多可以把16个列合并 成一个单独的复合索引，构成复合索引的列的总长度不能超过900字节
2. 在复合索引中，所有的列必须来自同一个表中，不能跨 表建立复合列
3. 在复合索引中，按照从左到右是重要性进行索引，原则上，应该首先定义最唯一的列



## 1.7 聚簇索引的体系结构

索 引的结构类似于树状结构，树的顶部称为叶级，树的其它部分称为非叶级，树的根部在非叶级中。在聚簇索引中，表中的数据所在的数据页是叶级，在叶级之上的索引页是非叶级，索引数据所在的索引页是非叶级。

在聚簇索引中，数据 值的顺序总是按照**升序排列**。应该在表中经常搜索的列或者按照顺序访问的列上创建聚簇索引。

当创建聚簇索引时，应该考虑这些因素：

1. 每一个表只能 有一个聚簇索引，因为表中行的物理顺序和索引中行的物理顺序是相同的
2. 在创建任何非聚簇索引之前创建聚簇索引，这是因为聚簇索引改变了表中行的物理顺序，数据行按照一定的顺序排列，并且自动维护这个顺序；
3. 关键值的唯一性要么使用UNIQUE关键字明确维护，要么由一个内部的 唯一标识符明确维护，这些唯一性标识符是系统自己使用的，用户不能访问；
4. 聚簇索引的平均大小大约是数据表的百分之五

## 1.8 非聚簇索引的体系结构 

在非聚簇索引中，叶级仅包含关键值，而没有包含数据行。非聚簇索引表示行的逻辑顺序。

非聚簇索引有两种体系结构:

### 1.8.1 在没有聚簇索引的表上索引

如果一个数据表中没有聚簇索引，那么这个数据表也称为数据堆。

当非聚簇索引在数据堆的顶部创建时，系统使用索引页中的行标识符指向数据页中的记录。行标识符 存储了数据所在位置的信息。数据堆是通过使用索引分配图（IAM）页来维护的。IAM页包含了数据堆所在簇的存储信息。在系统表sysindexes中， 有一个指针指向了与数据堆相关的第一个IAM页。系统使用IAM页在数据堆中浏览和寻找可以插入新的记录行的空间。这些数据页和在这些数据页中的记录没有 任何的顺序并且也没有链接在一起。在这些数据页之间的唯一的连接是IAM中记录的顺序。当在数据堆上创建了非聚簇索引时，叶级中包含了指向数据页的行标识 符。行标识符指定记录行的逻辑顺序，由文件ID、页号和行ID组成。这些行的标识符维持唯一性。非聚簇索引的叶级页的顺序不同于表中数据的物理顺序。这些 关键值在叶级中以升序维持。 

### 1.8.2 在有聚簇索引的表上创建索引

聚簇键存储了数据的位置信 息。如果某一个表有聚簇索引，那么非聚簇索引的叶级包含了映射到聚簇键的聚簇键值，而不是映射到物理的行标识符。当系统访问有非聚簇索引的表中数据时，并 且这种非聚簇索引创建在聚簇索引上，那么它首先从非聚簇索引来找到指向聚簇索引的指针，然后通过使用聚簇索引来找到数据。 

 